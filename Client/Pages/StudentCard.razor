@page "/students/card"
@page "/students/card/{StudentId:guid}"

@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@using System.Text.Json
@using SchoolApp.Shared.Models


<PageHeader Title="Report Card" />

@if (Student == null)
{
    <LoadingSpinner />
}
else
{
    <div class="card shadow-sm border-0 rounded-3 p-3; margin: auto;">
        <div class="d-flex align-items-center">
            <img src="id_pic.png" alt="Student Photo"
                 class="rounded border me-3"
                 style="width: 150px; height: 150px; object-fit: cover;" />

            <div class="flex-grow-1">
                <h4 class="fw-bold mb-1 text-primary">@Student.FullName</h4>
                <p class="mb-1"><strong>Birthdate:</strong> @Student.DateOfBirth.ToString("MMMM dd, yyyy")</p>
                <p class="mb-1"><strong>Gender:</strong> @Student.Gender</p>
                <p class="mb-1"><strong>Address:</strong> @Student.Address</p>
                <p class="mb-1"><strong>Guardian:</strong> Parents Name</p>
                <p class="mb-1"><strong>Contact#:</strong> @Student.ContactNumber</p>
            </div>
        </div>

        <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center mt-2 py-3">
            <span class="fs-5">Grade Level: @CurrentGradeLevel</span>
            <span class="fs-5">Section: @CurrentSection</span>
        </div>
    </div>

    @if (Subjects == null)
    {
        <LoadingSpinner />
    }
    else if (!Subjects.Any())
    {
        <p>No subjects found for report card.</p>
    }
    else
    {
        <table class="table table-striped" >
            <thead>
                <tr>
                    <th style="width:20%;">Subject</th>
                    <th style="width:10%;">1st Grading</th>
                    <th style="width:10%;">2nd Grading</th>
                    <th style="width:10%;">3rd Grading</th>
                    <th style="width:10%;">4th Grading</th>
                    <th style="width:10%;">Final Grade</th>
                    <th style="width:30%;">Remarks</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var subject in Subjects)
                {
                    var first = GetStudentScore(subject.Id, Student.Id, 1);
                    var second = GetStudentScore(subject.Id, Student.Id, 2);
                    var third = GetStudentScore(subject.Id, Student.Id, 3);
                    var fourth = GetStudentScore(subject.Id, Student.Id, 4);

                    var finalGrade = (first + second + third + fourth) / 4;
                    var remarks = finalGrade >= 75 ? "Passed" : "Failed";
                    var remarksClass = finalGrade >= 75 ? "text-success" : "text-danger";

                    <tr>
                        <td>@subject.Name</td>
                        <td class="text-center">@first</td>
                        <td class="text-center">@second</td>
                        <td class="text-center">@third</td>
                        <td class="text-center">@fourth</td>
                        <td class="text-center"><strong>@finalGrade</strong></td>
                        <td class="text-center @remarksClass">@remarks</td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@code {
    [Parameter] public Guid StudentId { get; set; }

    private Student? Student;
    private List<Student> AllStudents = new();
    private List<Subject> Subjects = new();
    private List<SubGradingItem> SubGradingItems = new();
    private List<SubGradingScore> SubGradingScores = new();

    private string CurrentSchoolYear = "N/A";
    private string CurrentGradeLevel = "N/A";
    private string CurrentSection = "N/A";

    protected override async Task OnParametersSetAsync()
    {
        if (StudentId == Guid.Empty)
        {
            Student = null;
            try
            {
                AllStudents = await Http.GetFromJsonAsync<List<Student>>("api/student");
                var jsonAllStudents = JsonSerializer.Serialize(AllStudents, new JsonSerializerOptions { WriteIndented = true });
                await JS.InvokeVoidAsync("alert", $"Loaded All Students:\n{jsonAllStudents}");
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"Failed to load students: {ex.Message}");
            }
        }
        else
        {
            try
            {
                Student = await Http.GetFromJsonAsync<Student>($"api/student/{StudentId}");
                await LoadRelatedSchoolData();

                var allSubjects = await Http.GetFromJsonAsync<List<Subject>>("api/subject") ?? new();

                //Filter by GradeLevelId
                if (Student?.GradeLevelId != null && Student.GradeLevelId != Guid.Empty)
                {
                    Subjects = allSubjects
                        .Where(s => s.GradeLevelId == Student.GradeLevelId)
                        .ToList();
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "⚠️ Student has no valid GradeLevelId, no subjects filtered.");
                    Subjects = new();
                }

                SubGradingItems = await Http.GetFromJsonAsync<List<SubGradingItem>>("api/SubGradingItem") ?? new();
                SubGradingScores = await Http.GetFromJsonAsync<List<SubGradingScore>>($"api/SubGradingScore/ByStudent/{StudentId}") ?? new();
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"❌ Failed to fetch data: {ex.Message}");
            }
        }
    }


    private async Task LoadRelatedSchoolData()
    {
        try
        {
            var gradeLevels = await Http.GetFromJsonAsync<List<GradeLevel>>("api/GradeLevel") ?? new();
            var sections = await Http.GetFromJsonAsync<List<SchoolSection>>("api/SchoolSection") ?? new();

            if (Student != null)
            {
                CurrentGradeLevel = gradeLevels.FirstOrDefault(gl => gl.Id == Student.GradeLevelId)?.LevelName ?? "N/A";
                CurrentSection = sections.FirstOrDefault(ss => ss.Id == Student.SchoolSectionId)?.SectionName ?? "N/A";
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error loading school info: {ex.Message}");
        }
    }

    private double GetStudentScore(Guid subjectId, Guid studentId, int gradingPeriod)
    {
        var itemsForSubject = SubGradingItems
            .Where(i => i.SubjectId == subjectId && i.GradingPeriod == gradingPeriod)
            .Select(i => i.Id)
            .ToList();

        var scores = SubGradingScores
            .Where(s => itemsForSubject.Contains(s.SubGradingItemId) &&
                        s.StudentId == studentId &&
                        s.GradingPeriod == gradingPeriod)
            .Select(s => s.PercentSubject);

        return scores.Any() ? scores.Sum() : 0;
    }

    private void OnStudentSelected(ChangeEventArgs e)
    {
        if (Guid.TryParse(e.Value?.ToString(), out Guid selectedId))
        {
            NavigationManager.NavigateTo($"/students/card/{selectedId}");
        }
    }
}
