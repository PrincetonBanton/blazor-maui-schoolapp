@page "/attendance/calendar"
@using SchoolApp.Client.Shared
@using SchoolApp.Client.Shared.Calendars
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@inject SchoolApp.Shared.Services.SchoolContextService SchoolContext

<AuthGuard>
    <PageHeader Title="School Year" />

    <div style="display: flex; gap: 0rem; margin-bottom: 10px">
        <button title="Toggle Calendar" @onclick="ToggleMonthCalendar">
            @(ShowMonthCalendar ? "📅" : "🗓️")
        </button>
        <button title="Toggle Now" @onclick="ResetToToday">
            🕒
        </button>
    </div>

    <div class="fade-in" @key="FadeKey">
        <div class="year-view @(ShowMonthCalendar ? "hide" : "show")">
            <CalendarYear SelectedMonth="@SelectedMonth"
                          SelectedYear="@SelectedYear"
                          SelectedDay="@SelectedDay"
                          OnDayClicked="OnDayClicked"
                          OnMonthSelected="HandleMonthSelected"
                          SchoolYearStart="@SchoolContext.GetSelectedSchoolYearStart()"
                          SchoolYearEnd="@SchoolContext.GetSelectedSchoolYearEnd()" />
        </div>
        <div class="month-view @(ShowMonthCalendar ? "show" : "hide")">
            <CalendarMonth DaysInMonth="DaysInMonth"
                           StartOffset="StartOffset"
                           EndOffset="EndOffset"
                           OnDayClicked="OnDayClicked" />
        </div>
    </div>


</AuthGuard>

<style>
    button {
        background: none;
        border: none;
        font-size: 3rem;
        cursor: pointer;
        padding: 0;
        line-height: 1; /* remove extra vertical spacing */
        display: inline-flex; /* remove inline-block extra spacing */
        align-items: center;
        justify-content: center;
    }

    .year-view,
    .month-view {
        transition: transform 0.35s ease, opacity 0.35s ease;
        opacity: 1;
        transform: scale(1);
        position: relative;
    }

        .year-view.hide,
        .month-view.hide {
            transform: scale(0.95);
            opacity: 0;
            position: absolute;
            pointer-events: none;
            height: 0;
            overflow: hidden;
        }

        .year-view.show,
        .month-view.show {
            transform: scale(1);
            opacity: 1;
            position: relative;
            pointer-events: auto;
            height: auto;
        }
</style>

@code {
    public int SelectedMonth { get; set; } = DateTime.Now.Month;
    public int SelectedYear { get; set; } = DateTime.Now.Year;
    private DateTime? SelectedDay { get; set; }
    private List<DateTime> DaysInMonth { get; set; } = new();
    private int StartOffset { get; set; }
    private int EndOffset { get; set; }
    private bool ShowMonthCalendar { get; set; } = true;
    private string FadeKey =>
     $"{SchoolContext.SelectedSchoolYearId}-{SchoolContext.SelectedGradeLevelId}-{SchoolContext.SelectedSchoolSectionId}";

    protected override void OnInitialized()
    {
        LoadCalendar();
        SchoolContext.OnContextChanged += StateHasChanged;
    }

    public void Dispose()
    {
        SchoolContext.OnContextChanged -= StateHasChanged;
    }

    private void LoadCalendar()
    {
        DaysInMonth = Enumerable
            .Range(1, DateTime.DaysInMonth(SelectedYear, SelectedMonth))
            .Select(d => new DateTime(SelectedYear, SelectedMonth, d))
            .ToList();

        var firstDay = DaysInMonth.First();
        var lastDay = DaysInMonth.Last();

        StartOffset = (int)firstDay.DayOfWeek;
        EndOffset = 6 - (int)lastDay.DayOfWeek;
    }

    private void ToggleMonthCalendar()
    {
        ShowMonthCalendar = !ShowMonthCalendar;
    }

    private void OnDayClicked(DateTime day)
    {
        NavigationManager.NavigateTo($"/attendance/list/{day:ddMMyyyy}");
    }

    private async Task HandleMonthSelected((int Month, int Year) data)
    {
        SelectedMonth = data.Month;
        SelectedYear = data.Year;
        LoadCalendar();
        ShowMonthCalendar = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task ResetToToday()
    {
        var today = DateTime.Now;
        SelectedYear = today.Year;
        SelectedMonth = today.Month;
        SelectedDay = today;
        LoadCalendar();
        ShowMonthCalendar = true;
        await InvokeAsync(StateHasChanged);
    }



}

