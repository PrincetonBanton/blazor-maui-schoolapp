@page "/subject/setup"
@page "/subject/setup/{SubjectId:guid}"

@inject HttpClient Http
@inject IJSRuntime JS
@using System.Text.Json
@using SchoolApp.Shared.Models
@using SchoolApp.Client.Helpers
@inject NavigationManager NavigationManager
@inject SchoolApp.Shared.Services.SchoolContextService SchoolContext

<div class="d-flex align-items-center justify-content-between mb-1">
    <select class="form-select mb-3" style="width: 300px; height: 38px;" @onchange="OnSubjectChanged">
        @foreach (var subject in Subjects)
        {
            <option value="@subject.Id" selected="@(SelectedSubjectId == subject.Id)">
                SETUP - @subject.Name
            </option>
        }
    </select>
    <a href="/subject/list" title="Back to List"
       class="d-flex align-items-center justify-content-center text-white bg-primary rounded-circle"
       style="width: 50px; height: 50px; text-decoration: none; font-size: 1.2rem;">
        ↩
    </a>
</div>

@if (Components.Any())
{
    <table class="table table-bordered">
        <thead class="table-primary">
            <tr>
                <th style="width: 25%;">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold">Component</span>
                        @if (Math.Round(Components.Sum(c => c.Percentage)) < 100)
                        {
                            <button class="btn btn-primary btn-sm rounded-circle"
                                    style="width: 28px; height: 28px; padding: 0;"
                                    title="Add Component"
                                    @onclick="() => ShowAddComponentModal = true">
                                +
                            </button>
                        }
                    </div>
                </th>
                <th style="width: 10%;">Subject %</th>
                <th style="width: 25%;">Subcomponent</th>
                <th style="width: 10%;">Component %</th>
                <th style="width: 30%;"></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var comp in Components)
            {
                var rowspan = comp.Subcomponents.Count == 0 ? 1 : comp.Subcomponents.Count;
                var compTotal = Math.Round(Components.Sum(c => c.Percentage));
                var subTotal = Math.Round(comp.Subcomponents.Sum(s => s.Percentage));

                <tr>
                    <!-- COMPONENT NAME + EDIT BUTTON -->
                    <td rowspan="@rowspan" style="color:@(subTotal == 100 ? "black" : "red")">
                        <div class="d-flex justify-content-between align-items-center">
                            @comp.Name
                            <button class="btn btn-warning btn-sm rounded-circle"
                                    style="width: 28px; height: 28px; padding: 0;"
                                    title="Edit Component"
                                    @onclick="() => EditComponent(comp)">
                                ✏️
                            </button>
                        </div>
                    </td>
                    <td rowspan="@rowspan" style="color:@(compTotal == 100 ? "black" : "red")">
                        @comp.Percentage%
                    </td>

                    @if (comp.Subcomponents.Count > 0)
                    {
                        <!-- FIRST SUBCOMPONENT -->
                        <td>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>@comp.Subcomponents[0].Name</span>
                                @if (subTotal < 100)
                                {
                                    <button class="btn btn-primary btn-sm rounded-circle"
                                            style="width: 28px; height: 28px; padding: 0;"
                                            title="Add Subcomponent"
                                            @onclick="() => OpenSubcomponentModal(comp.Id)">
                                        +
                                    </button>
                                }
                            </div>
                        </td>
                        <td>@comp.Subcomponents[0].Percentage%</td>
                        <td>
                            <div class="d-flex gap-3">
                                <button class="btn btn-warning btn-sm rounded-circle"
                                        style="width: 28px; height: 28px; padding: 0;"
                                        title="Edit Subcomponent"
                                        @onclick="() => EditSubcomponent(comp.Subcomponents[0])">
                                    ✏️
                                </button>
                                <button class="btn btn-danger btn-sm rounded-circle"
                                        style="width: 28px; height: 28px; padding: 0;"
                                        title="Delete Subcomponent"
                                        @onclick="() => OnDeleteSubcomponentClicked(comp.Subcomponents[0])">
                                    🗑️
                                </button>
                            </div>
                        </td>
                    }
                    else
                    {
                        <!-- NO SUBCOMPONENTS -->
                        <td>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">No subcomponents</span>
                                <button class="btn btn-primary btn-sm rounded-circle"
                                        style="width: 28px; height: 28px; padding: 0;"
                                        title="Add Subcomponent"
                                        @onclick="() => OpenSubcomponentModal(comp.Id)">
                                    +
                                </button>
                            </div>
                        </td>
                        <td>0%</td>
                        <td></td>
                    }
                </tr>

                @for (int i = 1; i < comp.Subcomponents.Count; i++)
                {
                    var sub = comp.Subcomponents[i];
                    <tr>
                        <td>@sub.Name</td>
                        <td>@sub.Percentage%</td>
                        <td>
                            <div class="d-flex gap-3">
                                <button class="btn btn-warning btn-sm rounded-circle"
                                        style="width: 28px; height: 28px; padding: 0;"
                                        title="Edit Subcomponent"
                                        @onclick="() => EditSubcomponent(sub)">
                                    ✏️
                                </button>
                                <button class="btn btn-danger btn-sm rounded-circle"
                                        style="width: 28px; height: 28px; padding: 0;"
                                        title="Delete Subcomponent"
                                        @onclick="() => OnDeleteSubcomponentClicked(sub)">
                                    🗑️
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>

    <h5 class="mt-4 mb-2 px-3 py-2 bg-primary text-white d-inline-block" style="width:320px">
        Subject Status
    </h5>

    <table class="table table-bordered">
        <colgroup>
            <col style="width: 25%;" />
            <col style="width: 10%;" />
            <col style="width: 25%;" />
            <col style="width: 10%;" />
            <col style="width: 30%;" />
        </colgroup>
        <tbody>
            @foreach (var comp in Components)
            {
                var compTotal = Math.Round(Components.Sum(c => c.Percentage));
                var subTotal = Math.Round(comp.Subcomponents?.Sum(s => s.Percentage) ?? 0);
                var subNames = comp.Subcomponents != null && comp.Subcomponents.Any()
                ? string.Join(", ", comp.Subcomponents.Select(s => s.Name))
                : "-";

                <tr>
                    <td>@comp.Name</td>
                    <td style="color:@(compTotal == 100 ? "black" : "red")">@comp.Percentage%</td>
                    <td>@subNames</td>
                    <td style="color:@(subTotal == 100 ? "black" : "red")">@subTotal%</td>
                    <td>
                        <span class="fw-bold @(subTotal == 100 && compTotal == 100 ? "text-success" : "text-danger")">
                            @((subTotal == 100 && compTotal == 100) ? "Valid" : "Invalid")
                        </span>
                    </td>
                </tr>
            }

        </tbody>
    </table>
}
else if (SelectedSubjectId != null)
{
    <div class="text-muted">
        <p>No components found for this subject.</p>
        <button class="btn btn-warning btn-sm" @onclick="() => ShowAddComponentModal = true">Add First Component</button>
    </div>
}

@if (SelectedSubjectId != null)
{
    @if (ShowAddComponentModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="z-index: 1050;">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            @(IsEditingComponent ? "Edit Component" : "Add Component")
                        </h5>
                        <button type="button" class="btn-close" aria-label="Close"
                                @onclick="CloseComponentModal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="text" class="form-control mb-2" placeholder="Component Name" @bind="NewComponentName" />
                        <input type="number" class="form-control mb-2" placeholder="% of Subject" @bind="NewComponentPercentage" />
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" style="width: 150px" @onclick="CloseComponentModal">Cancel</button>
                        @if (IsEditingComponent)
                        {
                            <button class="btn btn-warning" style="width: 150px" @onclick="OnUpdateComponentClicked">Update</button>
                        }
                        else
                        {
                            <button class="btn btn-success" style="width: 150px" @onclick="OnAddComponentClicked">Save</button>
                        }

                    </div>
                </div>
            </div>
        </div>
    }

    @if (ShowAddSubcomponentModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="z-index: 1050;">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            @(IsEditingSubcomponent ? "Edit Subcomponent" : "Add Subcomponent")
                        </h5>
                        <button type="button" class="btn-close" aria-label="Close"
                                @onclick="CloseSubcomponentModal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Component:</strong> @Components.FirstOrDefault(c => c.Id == SelectedComponentIdForSub)?.Name</p>
                        <input type="text" class="form-control mb-2" placeholder="Subcomponent Name" @bind="NewSubcomponentName" />
                        <input type="number" class="form-control mb-2" placeholder="% of Component" @bind="NewSubcomponentPercentage" />
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" style="width: 150px" @onclick="CloseSubcomponentModal">Cancel</button>
                        @if (IsEditingSubcomponent)
                        {
                            <button class="btn btn-warning" style="width: 150px" @onclick="OnUpdateSubcomponentClicked">Update</button>
                        }
                        else
                        {
                            <button class="btn btn-success" style="width: 150px" @onclick="OnAddSubcomponentClicked">Save</button>
                        }

                    </div>
                </div>
            </div>
        </div>
    }
}

@if (SelectedSubject != null && SelectedSubject.IsValidated)
{
    <div class="mt-3 fw-bold text-success">Template Validated</div>
}
else if (IsTemplateStructureValid)
{
    <button class="btn btn-primary mt-3" @onclick="OnFinalValidateClicked">Validate Template</button>
}
else
{
    <div class="@ValidationMessageClass" style="margin-top: 1rem; font-weight: bold;">@ValidationMessage</div>
}

@code {
    [Parameter]
    public Guid? SubjectId { get; set; }

    private Guid? SelectedSubjectId;
    private Guid? SelectedComponentIdForSub = null;
    private List<Subject> Subjects = new();
    private List<Component> Components = new();
    private List<Subcomponent> SubComponents = new();

    private bool ShowAddComponentModal = false;
    private string NewComponentName = string.Empty;
    private double NewComponentPercentage = 0;

    private bool ShowAddSubcomponentModal = false;
    private string NewSubcomponentName = string.Empty;
    private double NewSubcomponentPercentage = 0;

    private void OpenSubcomponentModal(Guid componentId)
    {
        SelectedComponentIdForSub = componentId;
        NewSubcomponentName = string.Empty;
        NewSubcomponentPercentage = 0;
        ShowAddSubcomponentModal = true;
    }

    private string ValidationMessage { get; set; }
    private string ValidationMessageClass { get; set; }
    private bool IsTemplateStructureValid = false;
    private Subject SelectedSubject => Subjects.FirstOrDefault(s => s.Id == SelectedSubjectId);

    private bool IsEditingComponent = false;
    private Guid? EditingComponentId = null;

    private bool IsEditingSubcomponent = false;
    private Guid? EditingSubcomponentId = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadSubjects();
        if (SubjectId != null && SubjectId != Guid.Empty)
        {
            SelectedSubjectId = SubjectId;
            var subject = await Http.GetFromJsonAsync<Subject>($"api/subject/{SubjectId}");
            await LoadComponents();
        }
    }

    private async Task LoadSubjects()
    {
        try
        {
            var allSubjects = await Http.GetFromJsonAsync<List<Subject>>("api/subject") ?? new();

            if (SchoolContext.SelectedGradeLevelId.HasValue)
            {
                Subjects = allSubjects
                    .Where(s => s.GradeLevelId == SchoolContext.SelectedGradeLevelId.Value && !s.IsValidated)
                    .ToList();
            }
            else
            {
                Subjects = new();
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error loading subjects: {ex.Message}");
        }
    }

    private async Task OnSubjectChanged(ChangeEventArgs e)
    {
        try
        {
            var value = e?.Value?.ToString();
            if (Guid.TryParse(value, out var subjectId))
            {
                SelectedSubjectId = subjectId;
                await LoadComponents();
            }
            else
            {
                SelectedSubjectId = null;
                Components.Clear();
                await JS.InvokeVoidAsync("alert", "Invalid subject selected.");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error fetching components: {ex.Message}");
        }
    }

    private async Task LoadComponents()
    {   
        if (SelectedSubjectId == Guid.Empty)
        {
            await JS.InvokeVoidAsync("alert", "Please select a valid subject.");
            return;
        }

        try
        {
            var rescomp = await Http.GetAsync($"api/Subject/{SelectedSubjectId}/Components");

            if (!rescomp.IsSuccessStatusCode)
            {
                var errorContent = await rescomp.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Failed to load components:\n{errorContent}");
                return;
            }
            Components = await rescomp.Content.ReadFromJsonAsync<List<Component>>() ?? new List<Component>();

            foreach (var comp in Components)
            {
                var resub = await Http.GetAsync($"api/Subcomponent/by-component/{comp.Id.ToString().ToUpper()}");

                if (!resub.IsSuccessStatusCode)
                {
 
                    var errorContent = await resub.Content.ReadAsStringAsync();
                    await JS.InvokeVoidAsync("alert", $"Failed to load components:\n{errorContent}");
                    return;
                }
                comp.Subcomponents = await resub.Content.ReadFromJsonAsync<List<Subcomponent>>() ?? new List<Subcomponent>();
            }


            // Trigger validation after data has loaded and rendered
            StateHasChanged(); // Let the UI update first
            await Task.Delay(100);
            await ValidateComponentAndSubcomponentPercentages();

        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error loading components: {ex.Message}");
        }
    }

    private async Task OnAddComponentClicked()
    {
        if (SelectedSubjectId == null || string.IsNullOrWhiteSpace(NewComponentName) || NewComponentPercentage <= 0)
        {
            await JS.InvokeVoidAsync("alert", "Please provide valid component name and percentage.");
            return;
        }

        if (!IsComponentPercentageValid(NewComponentPercentage))
        {
            await JS.InvokeVoidAsync("alert", "Total component percentages cannot exceed 100%.");
            return;
        }

        var newComponent = new Component
        {
            Name = NewComponentName,
            Percentage = NewComponentPercentage,
            SubjectId = SelectedSubjectId.Value
        };

        try
        {
            var response = await Http.PostAsJsonAsync("api/component", newComponent);
            if (response.IsSuccessStatusCode)
            {
                NewComponentName = string.Empty;
                NewComponentPercentage = 0;
                ShowAddComponentModal = false;
                await LoadComponents();
            }
            else
            {
                var err = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Failed to add component: {err}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"AddComponent error: {ex.Message}");
        }
    }

    private async Task OnUpdateComponentClicked()
    {
        if (EditingComponentId == null || string.IsNullOrWhiteSpace(NewComponentName) || NewComponentPercentage <= 0)
        {
            await JS.InvokeVoidAsync("alert", "Please provide valid component name and percentage.");
            return;
        }

        if (!IsComponentPercentageValid(NewComponentPercentage, EditingComponentId))
        {
            await JS.InvokeVoidAsync("alert", "Total component percentages cannot exceed 100%.");
            return;
        }

        var updatedComponent = new Component
        {
            Id = EditingComponentId.Value,
            Name = NewComponentName,
            Percentage = NewComponentPercentage,
            SubjectId = SelectedSubjectId.Value
        };

        try
        {
            var response = await Http.PutAsJsonAsync($"api/component/{updatedComponent.Id}", updatedComponent);
            if (response.IsSuccessStatusCode)
            {
                CloseComponentModal();
                await LoadComponents();
            }
            else
            {
                var err = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Failed to update component: {err}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"UpdateComponent error: {ex.Message}");
        }
    }

    private async Task OnAddSubcomponentClicked()
    {
        if (SelectedComponentIdForSub == null || string.IsNullOrWhiteSpace(NewSubcomponentName) || NewSubcomponentPercentage <= 0)
        {
            await JS.InvokeVoidAsync("alert", "Please provide valid subcomponent name and percentage.");
            return;
        }

        if (!IsSubcomponentPercentageValid(SelectedComponentIdForSub.Value, NewSubcomponentPercentage))
        {
            await JS.InvokeVoidAsync("alert", "Total subcomponent percentages cannot exceed 100%.");
            return;
        }

        var newSubcomponent = new Subcomponent
        {
            Name = NewSubcomponentName,
            Percentage = NewSubcomponentPercentage,
            ComponentId = SelectedComponentIdForSub.Value
        };

        try
        {
            var response = await Http.PostAsJsonAsync("api/subcomponent", newSubcomponent);
            if (response.IsSuccessStatusCode)
            {
                NewSubcomponentName = string.Empty;
                NewSubcomponentPercentage = 0;
                ShowAddSubcomponentModal = false;
                await LoadComponents();
            }
            else
            {
                var err = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Failed to add subcomponent: {err}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"AddSubcomponent error: {ex.Message}");
        }
    }

    private async Task OnUpdateSubcomponentClicked()
    {
        if (EditingSubcomponentId == null || string.IsNullOrWhiteSpace(NewSubcomponentName) || NewSubcomponentPercentage <= 0)
        {
            await JS.InvokeVoidAsync("alert", "Please provide valid subcomponent name and percentage.");
            return;
        }

        if (!IsSubcomponentPercentageValid(SelectedComponentIdForSub.Value, NewSubcomponentPercentage, EditingSubcomponentId))
        {
            await JS.InvokeVoidAsync("alert", "Total subcomponent percentages cannot exceed 100%.");
            return;
        }

        var updatedSub = new Subcomponent
        {
            Id = EditingSubcomponentId.Value,
            Name = NewSubcomponentName,
            Percentage = NewSubcomponentPercentage,
            ComponentId = SelectedComponentIdForSub.Value
        };

        try
        {
            var response = await Http.PutAsJsonAsync($"api/subcomponent/{updatedSub.Id}", updatedSub);
            if (response.IsSuccessStatusCode)
            {
                CloseSubcomponentModal();
                await LoadComponents();
            }
            else
            {
                var err = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Failed to update subcomponent: {err}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"UpdateSubcomponent error: {ex.Message}");
        }
    }

    private async Task OnDeleteSubcomponentClicked(Subcomponent sub)
{
    var confirm = await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to delete the subcomponent '{sub.Name}'?");
    if (!confirm) return;

    try
    {
        var response = await Http.DeleteAsync($"api/subcomponent/{sub.Id}");
        if (response.IsSuccessStatusCode)
        {
            await LoadComponents();
        }
        else
        {
            var err = await response.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("alert", $"Failed to delete subcomponent: {err}");
        }
    }
    catch (Exception ex)
    {
        await JS.InvokeVoidAsync("alert", $"DeleteSubcomponent error: {ex.Message}");
    }
}

    private async Task OnFinalValidateClicked()
    {
        if (SelectedSubjectId == null)
        {
            await JS.InvokeVoidAsync("alert", "Please select a subject first.");
            return;
        }

        var confirm = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to validate this template?");
        if (!confirm) return;
        try
        {
            var response = await Http.PutAsync($"api/subject/validate/{SelectedSubjectId}", null);

            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "Template validated successfully.");
                await LoadSubjects();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Failed to validate template: {error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error validating template: {ex.Message}");
        }
    }
    private async Task ValidateComponentAndSubcomponentPercentages()
    {
        var result = TemplateValidator.Validate(Components);
        IsTemplateStructureValid = result.IsValid;
        ValidationMessage = result.Message;
        ValidationMessageClass = result.CssClass;
    }

    private bool IsComponentPercentageValid(double newPercentage, Guid? editingId = null)
    {
        // Calculate total excluding the one being edited (if any)
        double currentTotal = Components
            .Where(c => editingId == null || c.Id != editingId.Value)
            .Sum(c => c.Percentage);

        return currentTotal + newPercentage <= 100;
    }

    private bool IsSubcomponentPercentageValid(Guid componentId, double newPercentage, Guid? editingId = null)
    {
        var parent = Components.FirstOrDefault(c => c.Id == componentId);
        if (parent == null) return false;

        double currentTotal = parent.Subcomponents
            .Where(s => editingId == null || s.Id != editingId.Value)
            .Sum(s => s.Percentage);

        return currentTotal + newPercentage <= 100;
    }
    private void CloseComponentModal()
    {
        ShowAddComponentModal = false;
        IsEditingComponent = false;
        EditingComponentId = null;
        NewComponentName = string.Empty;
        NewComponentPercentage = 0;
    }

    private void CloseSubcomponentModal()
    {
        ShowAddSubcomponentModal = false;
        IsEditingSubcomponent = false;
        EditingSubcomponentId = null;
        NewSubcomponentName = string.Empty;
        NewSubcomponentPercentage = 0;
    }

    private void EditComponent(Component comp)
    {
        IsEditingComponent = true;
        EditingComponentId = comp.Id;
        NewComponentName = comp.Name;
        NewComponentPercentage = comp.Percentage;
        ShowAddComponentModal = true;
    }

    private void EditSubcomponent(Subcomponent sub)
    {
        IsEditingSubcomponent = true;
        EditingSubcomponentId = sub.Id;
        SelectedComponentIdForSub = sub.ComponentId;
        NewSubcomponentName = sub.Name;
        NewSubcomponentPercentage = sub.Percentage;
        ShowAddSubcomponentModal = true;
    }

}
