@using SchoolApp.Client.Shared
@using SchoolApp.Client.Shared.Modals
@inject IJSRuntime JS
@inject NavigationManager Nav

<div class="d-flex justify-content-between align-items-center mb-3 w-100"
     style="padding-bottom: 10px; border-bottom: 1px solid #e0e0e0;">

    <div style="font-size: 1.6rem; font-weight: 600; padding-top: 10px; color:darkblue">
        @Title
    </div>

    <div class="d-flex align-items-center" style="gap: 10px;">
        <div class="position-relative" style="width: 500px;">
            <input type="text" class="form-control pe-5" placeholder="Search..."
                   @bind="SearchText" @oninput="OnSearchChanged">
            <span class="position-absolute top-50 end-0 translate-middle-y me-3"
                  style="font-size: 1.5rem; color: gray; cursor: pointer;"
                  @onclick="TriggerUniversalSearch">
                🔍
            </span>
        </div>

        <button title="Setup"
                @onclick="() => ShowSetupModal = true"
                class="d-flex text-white bg-primary rounded-circle shadow align-items-center justify-content-center"
                style="width: 35px; height: 35px; text-decoration: none; font-size: 1.1rem; border:none;">
            ⚙️
        </button>

        <div class="d-flex align-items-center" style="gap: 6px;">
            <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center"
                 style="width: 35px; height: 35px; color: white; font-size: 1.1rem;">
                @UserInitials
            </div>
            <div style="font-weight: 500; font-size: 0.8rem; color: darkblue;">
                @LoginUserName
            </div>
        </div>

        <button title="Logout"
            @onclick="Logout"
            class="d-flex bg-primary text-white rounded-circle shadow align-items-center justify-content-center"
            style="width: 35px; height: 35px; font-size: 1rem; border: none;">
            ❌
        </button>
    </div>
</div>

@if (ShowSetupModal)
{
    <div class="modal-backdrop fade show"></div>

    <div class="modal d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Setup</h5>
                    <button class="btn-close" @onclick="() => ShowSetupModal = false"></button>
                </div>
                <SetupModal />
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public string Title { get; set; } = "";
    [Parameter] public EventCallback<string> OnSearch { get; set; }

    private string SearchText = "";
    private bool ShowSetupModal = false;
    private System.Timers.Timer debounceTimer;

    private string LoginUserName = "User";
    private string UserInitials = "U";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await LoadLoginUser();
    }

    private async Task LoadLoginUser()
    {
        var name = await JS.InvokeAsync<string>("localStorage.getItem", "loginUserName");
        if (!string.IsNullOrWhiteSpace(name))
        {
            LoginUserName = name;
            UserInitials = GetInitials(name);
            StateHasChanged();
        }
    }

    private string GetInitials(string fullName)
    {
        var parts = fullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length switch
        {
            0 => "U",
            1 => parts[0][0].ToString().ToUpper(),
            _ => $"{parts[0][0]}{parts[^1][0]}".ToUpper()
        };
    }

    private async Task TriggerUniversalSearch()
    {
        await OnSearch.InvokeAsync(SearchText);
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        SearchText = e.Value?.ToString() ?? "";

        debounceTimer?.Stop();
        debounceTimer = new System.Timers.Timer(300);
        debounceTimer.Elapsed += async (_, __) =>
        {
            debounceTimer.Stop();
            await InvokeAsync(() => OnSearch.InvokeAsync(SearchText));
        };
        debounceTimer.Start();
    }

    private async Task Logout()
    {
        await JS.InvokeVoidAsync("localStorage.removeItem", "isLoggedIn");
        Nav.NavigateTo("/login", true);
    }
}
